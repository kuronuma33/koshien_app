<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”²å­åœ’ã¸ã®é“ã®ã‚Š</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
            min-height: 100vh;
            padding: 10px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #1976D2, #0D47A1);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2em;
            margin-bottom: 5px;
        }
        
        .map-section {
            padding: 20px;
            background: #f0f8ff;
        }
        
        .route-map {
            width: 100%;
            height: 200px;
            background: linear-gradient(90deg, #e3f2fd 0%, #bbdefb 50%, #90caf9 100%);
            border-radius: 15px;
            position: relative;
            border: 2px solid #1976D2;
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .route-line {
            position: absolute;
            top: 50%;
            left: 10px;
            right: 10px;
            height: 4px;
            background: #666;
            transform: translateY(-50%);
            border-radius: 2px;
        }
        
        .milestone {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            text-align: center;
            font-size: 12px;
            color: #333;
        }
        
        .milestone-marker {
            width: 12px;
            height: 12px;
            background: #666;
            border-radius: 50%;
            margin: 0 auto 5px;
        }
        
        .current-position {
            position: absolute;
            top: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            z-index: 10;
            transition: left 0.5s ease;
        }
        
        .progress-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .info-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        
        .info-number {
            font-size: 1.8em;
            font-weight: bold;
            color: #1976D2;
            margin-bottom: 5px;
        }
        
        .info-label {
            color: #666;
            font-size: 0.9em;
        }
        
        .stats-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            padding: 20px;
        }
        
        .training-panel, .health-panel {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
        }
        
        .panel-title {
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .health-display {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 20px 0;
        }
        
        .heart-icon {
            font-size: 2em;
            margin: 0 5px;
            transition: all 0.3s ease;
        }
        
        .heart-full {
            color: #e91e63;
        }
        
        .heart-empty {
            color: #ccc;
        }
        
        .boost-display {
            text-align: center;
            margin: 15px 0;
        }
        
        .boost-icon {
            font-size: 2em;
            color: #ff9800;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .input-section {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            border: 2px solid #e0e0e0;
        }
        
        .input-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 10px 0;
        }
        
        .input-label {
            font-weight: bold;
            color: #333;
        }
        
        .number-input {
            width: 80px;
            height: 40px;
            border: 2px solid #1976D2;
            border-radius: 8px;
            text-align: center;
            font-size: 1.1em;
            font-weight: bold;
        }
        
        .action-btn {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 12px 20px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
        }
        
        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76,175,80,0.3);
        }
        
        .action-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .dash-btn {
            background: linear-gradient(135deg, #FF5722, #D84315);
        }
        
        .dash-btn:hover {
            box-shadow: 0 5px 15px rgba(255,87,34,0.3);
        }
        
        .flexibility-btn {
            background: linear-gradient(135deg, #9C27B0, #7B1FA2);
        }
        
        .flexibility-btn:hover {
            box-shadow: 0 5px 15px rgba(156,39,176,0.3);
        }
        
        .chart-section {
            padding: 20px;
            background: #f5f5f5;
        }
        
        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            height: 300px;
            position: relative;
        }
        
        .achievement-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: linear-gradient(135deg, #FFD700, #FFA000);
            color: #333;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            text-align: center;
            z-index: 1000;
            transition: transform 0.3s ease;
        }
        
        .achievement-popup.show {
            transform: translate(-50%, -50%) scale(1);
        }
        
        .warning {
            background: #ffebee;
            color: #c62828;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
            font-weight: bold;
        }
        
        .reset-section {
            padding: 20px;
            background: #f5f5f5;
            border-top: 1px solid #ddd;
        }
        
        .reset-btn {
            background: linear-gradient(135deg, #f44336, #d32f2f);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 10px 20px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .reset-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(244,67,54,0.3);
        }
        
        .save-info {
            background: #e8f5e8;
            color: #2e7d2e;
            padding: 8px;
            border-radius: 6px;
            margin: 10px 0;
            text-align: center;
            font-size: 0.8em;
        }
        
        .save-info {
            background: #e8f5e8;
            color: #2e7d2e;
            padding: 8px;
            border-radius: 6px;
            margin: 10px 0;
            text-align: center;
            font-size: 0.8em;
        }
        
        .reset-section {
            padding: 20px;
            background: #f5f5f5;
            border-top: 1px solid #ddd;
        }
        
        .reset-btn {
            background: linear-gradient(135deg, #f44336, #d32f2f);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 10px 20px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .reset-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(244,67,54,0.3);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>âš¾ ç”²å­åœ’ã¸ã®é“ã®ã‚Š âš¾</h1>
            <p>è‘›é£¾åŒºéŒå€‰ â†’ ç”²å­åœ’çƒå ´</p>
            <p id="currentDate"></p>
        </div>
        
        <div class="map-section">
            <div class="route-map">
                <div class="route-line"></div>
                
                <!-- å‡ºç™ºåœ°ç‚¹ -->
                <div class="milestone" style="left: 0%;">
                    <div class="milestone-marker"></div>
                    <div>è‘›é£¾åŒº<br>éŒå€‰</div>
                </div>
                
                <!-- ä¸­é–“åœ°ç‚¹ -->
                <div class="milestone" style="left: 12.5%;">
                    <div class="milestone-marker"></div>
                    <div>ç¥å¥ˆå·çœŒ</div>
                </div>
                
                <div class="milestone" style="left: 25%;">
                    <div class="milestone-marker"></div>
                    <div>é™å²¡çœŒ</div>
                </div>
                
                <div class="milestone" style="left: 37.5%;">
                    <div class="milestone-marker"></div>
                    <div>æ„›çŸ¥çœŒ</div>
                </div>
                
                <div class="milestone" style="left: 50%;">
                    <div class="milestone-marker"></div>
                    <div>å²é˜œçœŒ</div>
                </div>
                
                <div class="milestone" style="left: 62.5%;">
                    <div class="milestone-marker"></div>
                    <div>æ»‹è³€çœŒ</div>
                </div>
                
                <div class="milestone" style="left: 75%;">
                    <div class="milestone-marker"></div>
                    <div>äº¬éƒ½åºœ</div>
                </div>
                
                <div class="milestone" style="left: 87.5%;">
                    <div class="milestone-marker"></div>
                    <div>å¤§é˜ªåºœ</div>
                </div>
                
                <!-- ã‚´ãƒ¼ãƒ«åœ°ç‚¹ -->
                <div class="milestone" style="left: 100%;">
                    <div class="milestone-marker" style="background: #4CAF50;"></div>
                    <div>ç”²å­åœ’<br>çƒå ´</div>
                </div>
                
                <!-- ç¾åœ¨ä½ç½® -->
                <div class="current-position" id="currentPosition" style="left: 0%;">ğŸƒâ€â™‚ï¸</div>
            </div>
            
            <div class="progress-info">
                <div class="info-card">
                    <div class="info-number" id="totalSteps">0</div>
                    <div class="info-label">ç·æ­©æ•°</div>
                </div>
                <div class="info-card">
                    <div class="info-number" id="distanceTraveled">0.0</div>
                    <div class="info-label">é€²ã‚“ã è·é›¢(km)</div>
                </div>
                <div class="info-card">
                    <div class="info-number" id="nextMilestone">ç¥å¥ˆå·çœŒã¾ã§</div>
                    <div class="info-label" id="stepsToNext">120,000æ­©</div>
                </div>
                <div class="info-card">
                    <div class="info-number" id="stepsToGoal">1,000,000</div>
                    <div class="info-label">ã‚´ãƒ¼ãƒ«ã¾ã§æ­©æ•°</div>
                </div>
            </div>
        </div>
        
        <div class="stats-section">
            <div class="training-panel">
                <div class="panel-title">ğŸ‹ï¸â€â™‚ï¸ ä»Šæ—¥ã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°</div>
                
                <div class="health-display">
                    <span>ä½“åŠ›: </span>
                    <div id="healthHearts">
                        <span class="heart-icon heart-full">â™¥</span>
                        <span class="heart-icon heart-full">â™¥</span>
                        <span class="heart-icon heart-full">â™¥</span>
                    </div>
                </div>
                
                <div class="boost-display" id="boostDisplay" style="display: none;">
                    <div class="boost-icon">ğŸš€</div>
                    <div>ãƒ–ãƒ¼ã‚¹ãƒˆåŠ¹æœç™ºå‹•ä¸­ï¼<br>ç´ æŒ¯ã‚Š1å› = 15æ­©</div>
                </div>
                
                <div class="daily-limit">
                    ç´ æŒ¯ã‚Šå…¥åŠ›å›æ•°: <span id="swingInputCount">0</span>/3å›
                </div>
                
                <div class="input-section">
                    <div class="input-row">
                        <span class="input-label">ç´ æŒ¯ã‚Šå›æ•°:</span>
                        <input type="number" id="swingCount" class="number-input" min="0" value="0">
                    </div>
                    <button class="action-btn" id="addSwingBtn" onclick="addSwings()">ç´ æŒ¯ã‚Šå®Ÿè¡Œ</button>
                </div>
                
                <div class="input-section">
                    <div class="input-row">
                        <span class="input-label">ãƒ€ãƒƒã‚·ãƒ¥ (10mÃ—5æœ¬):</span>
                        <button class="action-btn dash-btn" id="dashBtn" onclick="performDash()">å®Ÿè¡Œ</button>
                    </div>
                </div>
                
                <div class="input-section">
                    <div class="input-row">
                        <span class="input-label">æŸ”è»Ÿä½“æ“:</span>
                        <button class="action-btn flexibility-btn" id="flexibilityBtn" onclick="performFlexibility()">å®Ÿè¡Œ</button>
                    </div>
                </div>
                
                <div id="warningMessage" class="warning" style="display: none;">
                    ä½“åŠ›ãŒä¸è¶³ã—ã¦ã„ã¾ã™ï¼æŸ”è»Ÿä½“æ“ã§ä½“åŠ›ã‚’å›å¾©ã—ã¦ãã ã•ã„ã€‚
                </div>
                
                <div class="save-info">
                    ğŸ”— URLã«è‡ªå‹•ä¿å­˜ä¸­<br>
                    <small>ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯æ¨å¥¨ï¼</small>
                </div>
            </div>
            
            <div class="health-panel">
                <div class="panel-title">ğŸ“Š ä»Šæ—¥ã®è¨˜éŒ²</div>
                <div class="info-card">
                    <div class="info-number" id="todaySwings">0</div>
                    <div class="info-label">ä»Šæ—¥ã®ç´ æŒ¯ã‚Šå›æ•°</div>
                </div>
                <div class="info-card">
                    <div class="info-number" id="todaySteps">0</div>
                    <div class="info-label">ä»Šæ—¥ã®æ­©æ•°</div>
                </div>
                <div class="info-card">
                    <div class="info-number" id="todayDistance">0.0</div>
                    <div class="info-label">ä»Šæ—¥ã®é€²è·é›¢(km)</div>
                </div>
                <div class="info-card">
                    <div class="info-number" id="consecutiveDays">0</div>
                    <div class="info-label">é€£ç¶šç·´ç¿’æ—¥æ•°</div>
                </div>
            </div>
        </div>
        
        <div class="chart-section">
            <div class="panel-title">ğŸ“ˆ éå»ã®å®Ÿç¸¾</div>
            <div class="chart-container">
                <canvas id="progressChart" width="800" height="260"></canvas>
            </div>
        </div>
        
        <div class="reset-section">
            <div class="panel-title">âš™ï¸ è¨­å®šãƒ»ãƒ‡ãƒ¼ã‚¿ç®¡ç†</div>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-bottom: 15px;">
                <button class="action-btn" onclick="exportGameData()">ğŸ“¤ ãƒ‡ãƒ¼ã‚¿æ›¸ãå‡ºã—</button>
                <div>
                    <input type="file" id="importFile" accept=".json" onchange="importGameData(event)" style="display: none;">
                    <button class="action-btn" onclick="document.getElementById('importFile').click()">ğŸ“¥ ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿</button>
                </div>
                <button class="reset-btn" onclick="resetAllData()">ğŸ—‘ï¸ å…¨ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆ</button>
            </div>
            
            <div class="save-info">
                ğŸ”— ãƒ‡ãƒ¼ã‚¿ã¯URLã«è‡ªå‹•ä¿å­˜ã•ã‚Œã¾ã™<br>
                <small>ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ã™ã‚Œã°ãƒ‡ãƒ¼ã‚¿å¾©å…ƒå¯èƒ½ï¼</small>
            </div>
            
            <p style="margin-top: 10px; color: #666; font-size: 0.9em;">
                â€»ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã§ã‚‚ç¢ºå®Ÿã«ãƒ‡ãƒ¼ã‚¿ãŒä¿å­˜ã•ã‚Œã¾ã™<br>
                â€»ä¸‡ä¸€ã®ãŸã‚ã«ã€Œãƒ‡ãƒ¼ã‚¿æ›¸ãå‡ºã—ã€ã§ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ãŠå‹§ã‚ã—ã¾ã™
            </p>
        </div>
    </div>
    
    <div class="achievement-popup" id="achievementPopup">
        <h2>ğŸ‰ ç´ æ™´ã‚‰ã—ã„ï¼ ğŸ‰</h2>
        <p id="achievementText"></p>
    </div>
    
    <script>
        // ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿
        let gameData = {
            totalSteps: 0,
            totalSwings: 0,
            health: 3, // æœ€å¤§3
            hasBoost: false,
            swingInputCount: 0, // ä»Šæ—¥ã®ç´ æŒ¯ã‚Šå…¥åŠ›å›æ•°
            lastDate: null, // æœ€å¾Œã«ãƒ—ãƒ¬ã‚¤ã—ãŸæ—¥
            consecutiveDays: 0,
            todayData: {
                swings: 0,
                steps: 0,
                distance: 0
            },
            history: []
        };
        
        // ç›®æ¨™è¨­å®š
        const TOTAL_DISTANCE_KM = 500; // è‘›é£¾åŒºã‹ã‚‰ç”²å­åœ’ã¾ã§ã®æ¦‚ç®—è·é›¢
        const STEP_DISTANCE_M = 0.52; // 1æ­©ã®è·é›¢ï¼ˆãƒ¡ãƒ¼ãƒˆãƒ«ï¼‰
        const TOTAL_STEPS = Math.ceil(TOTAL_DISTANCE_KM * 1000 / STEP_DISTANCE_M); // ç´„96ä¸‡æ­©
        
        // ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³è¨­å®š
        const milestones = [
            { name: "ç¥å¥ˆå·çœŒ", steps: Math.floor(TOTAL_STEPS * 0.125) },
            { name: "é™å²¡çœŒ", steps: Math.floor(TOTAL_STEPS * 0.25) },
            { name: "æ„›çŸ¥çœŒ", steps: Math.floor(TOTAL_STEPS * 0.375) },
            { name: "å²é˜œçœŒ", steps: Math.floor(TOTAL_STEPS * 0.5) },
            { name: "æ»‹è³€çœŒ", steps: Math.floor(TOTAL_STEPS * 0.625) },
            { name: "äº¬éƒ½åºœ", steps: Math.floor(TOTAL_STEPS * 0.75) },
            { name: "å¤§é˜ªåºœ", steps: Math.floor(TOTAL_STEPS * 0.875) },
            { name: "ç”²å­åœ’çƒå ´", steps: TOTAL_STEPS }
        ];
        
        // ãƒ‡ãƒ¼ã‚¿ä¿å­˜ãƒ»èª­ã¿è¾¼ã¿æ©Ÿèƒ½ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«å¯¾å¿œï¼‰
        function saveGameData() {
            try {
                const dataToSave = JSON.stringify(gameData);
                
                // æ–¹æ³•1: URLãƒãƒƒã‚·ãƒ¥ã«ä¿å­˜ï¼ˆæœ€ã‚‚ç¢ºå®Ÿï¼‰
                if (window.history && window.history.replaceState) {
                    try {
                        const currentUrl = window.location.href.split('#')[0];
                        window.history.replaceState(null, null, currentUrl + '#gamedata=' + encodeURIComponent(dataToSave));
                    } catch (e) {
                        // history API ãŒä½¿ãˆãªã„å ´åˆã¯ window.location.hash ã‚’ä½¿ç”¨
                        window.location.hash = 'gamedata=' + encodeURIComponent(dataToSave);
                    }
                }
                
                // æ–¹æ³•2: HTMLã®éš ã—è¦ç´ ã«ä¿å­˜
                let hiddenDataElement = document.getElementById('persistentGameData');
                if (!hiddenDataElement) {
                    hiddenDataElement = document.createElement('script');
                    hiddenDataElement.id = 'persistentGameData';
                    hiddenDataElement.type = 'application/json';
                    hiddenDataElement.style.display = 'none';
                    document.head.appendChild(hiddenDataElement);
                }
                hiddenDataElement.textContent = dataToSave;
                
                // æ–¹æ³•3: ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ«ã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ã‚’åŸ‹ã‚è¾¼ã¿
                const originalTitle = document.title.split(' | ')[0];
                document.title = originalTitle + ' | ' + btoa(dataToSave.substring(0, 100));
                
                // æ–¹æ³•4: Cookieã‚‚è©¦è¡Œï¼ˆHTTPSã¾ãŸã¯ãƒ­ãƒ¼ã‚«ãƒ«ã‚µãƒ¼ãƒãƒ¼ã®å ´åˆï¼‰
                try {
                    document.cookie = `koshienData=${encodeURIComponent(dataToSave)}; expires=${new Date(Date.now() + 365*24*60*60*1000).toUTCString()}; path=/; SameSite=Lax`;
                } catch (cookieError) {
                    console.log('Cookieä¿å­˜ã¯åˆ©ç”¨ã§ãã¾ã›ã‚“ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã®å ´åˆã¯æ­£å¸¸ï¼‰');
                }
                
                console.log('ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼ˆè¤‡æ•°ã®æ–¹æ³•ã§ï¼‰');
                showSaveIndicator();
                
            } catch (error) {
                console.error('ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        function loadGameData() {
            try {
                let savedData = null;
                
                // æ–¹æ³•1: URLãƒãƒƒã‚·ãƒ¥ã‹ã‚‰èª­ã¿è¾¼ã¿ï¼ˆæœ€å„ªå…ˆï¼‰
                if (window.location.hash) {
                    const hash = window.location.hash.substring(1);
                    if (hash.startsWith('gamedata=')) {
                        try {
                            savedData = decodeURIComponent(hash.substring(9));
                        } catch (e) {
                            console.log('URLãƒãƒƒã‚·ãƒ¥ã®è§£æã«å¤±æ•—');
                        }
                    }
                }
                
                // æ–¹æ³•2: HTMLã®éš ã—è¦ç´ ã‹ã‚‰èª­ã¿è¾¼ã¿
                if (!savedData) {
                    const hiddenElement = document.getElementById('persistentGameData');
                    if (hiddenElement && hiddenElement.textContent) {
                        savedData = hiddenElement.textContent;
                    }
                }
                
                // æ–¹æ³•3: Cookieã‹ã‚‰èª­ã¿è¾¼ã¿
                if (!savedData) {
                    try {
                        const cookies = document.cookie.split(';');
                        for (let cookie of cookies) {
                            const [name, value] = cookie.trim().split('=');
                            if (name === 'koshienData') {
                                savedData = decodeURIComponent(value);
                                break;
                            }
                        }
                    } catch (cookieError) {
                        console.log('Cookieèª­ã¿è¾¼ã¿ã‚¹ã‚­ãƒƒãƒ—');
                    }
                }
                
                if (savedData) {
                    try {
                        const loadedData = JSON.parse(savedData);
                        if (loadedData && typeof loadedData === 'object') {
                            gameData = { ...gameData, ...loadedData };
                            console.log('ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã—ãŸ');
                            return true;
                        }
                    } catch (parseError) {
                        console.error('ãƒ‡ãƒ¼ã‚¿ã®è§£æã«å¤±æ•—:', parseError);
                    }
                }
                
            } catch (error) {
                console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }
            return false;
        }
        
        // ä¿å­˜ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼è¡¨ç¤º
        function showSaveIndicator() {
            // æ—¢å­˜ã®ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’å‰Šé™¤
            const existing = document.querySelector('.save-indicator');
            if (existing) existing.remove();
            
            const indicator = document.createElement('div');
            indicator.className = 'save-indicator';
            indicator.innerHTML = 'ğŸ’¾ ä¿å­˜å®Œäº†';
            indicator.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #4CAF50;
                color: white;
                padding: 10px 15px;
                border-radius: 5px;
                font-size: 14px;
                z-index: 1000;
                animation: saveIndicatorAnim 2s ease-in-out;
            `;
            
            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®šç¾©
            if (!document.querySelector('#saveIndicatorStyle')) {
                const style = document.createElement('style');
                style.id = 'saveIndicatorStyle';
                style.textContent = `
                    @keyframes saveIndicatorAnim {
                        0% { opacity: 0; transform: translateY(-10px) scale(0.8); }
                        20% { opacity: 1; transform: translateY(0) scale(1); }
                        80% { opacity: 1; transform: translateY(0) scale(1); }
                        100% { opacity: 0; transform: translateY(-10px) scale(0.8); }
                    }
                `;
                document.head.appendChild(style);
            }
            
            document.body.appendChild(indicator);
            
            // 2ç§’å¾Œã«å‰Šé™¤
            setTimeout(() => {
                if (indicator.parentNode) {
                    indicator.parentNode.removeChild(indicator);
                }
            }, 2000);
        }
        
        // ãƒ‡ãƒ¼ã‚¿ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã¨ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½
        function exportGameData() {
            const dataToExport = JSON.stringify(gameData, null, 2);
            const blob = new Blob([dataToExport], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'koshien-game-backup.json';
            a.click();
            URL.revokeObjectURL(url);
            showAchievement('ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸï¼\nãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã—ã¦ãã ã•ã„ã€‚');
        }
        
        // ãƒ‡ãƒ¼ã‚¿ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ©Ÿèƒ½
        function importGameData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (importedData && typeof importedData === 'object') {
                        gameData = { ...gameData, ...importedData };
                        saveGameData();
                        updateDisplay();
                        updateMap();
                        drawChart();
                        showAchievement('ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸï¼');
                    }
                } catch (error) {
                    showAchievement('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                }
            };
            reader.readAsText(file);
        }
        
        // è‡ªå‹•ä¿å­˜ã®è¨­å®š
        function setupAutoSave() {
            // ãƒšãƒ¼ã‚¸é›¢è„±å‰ã«ãƒ‡ãƒ¼ã‚¿ä¿å­˜
            window.addEventListener('beforeunload', function(e) {
                saveGameData();
            });
            
            // å®šæœŸçš„ã«ãƒ‡ãƒ¼ã‚¿ä¿å­˜ï¼ˆ30ç§’ã”ã¨ï¼‰
            setInterval(function() {
                saveGameData();
            }, 30 * 1000);
            
            // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹å¤‰æ›´æ™‚ã«ã‚‚ä¿å­˜
            window.addEventListener('blur', function() {
                saveGameData();
            });
            
            window.addEventListener('focus', function() {
                saveGameData();
            });
            
            // ãƒšãƒ¼ã‚¸ã®visibilityå¤‰æ›´æ™‚ã«ã‚‚ä¿å­˜
            document.addEventListener('visibilitychange', function() {
                if (document.visibilityState === 'hidden') {
                    saveGameData();
                }
            });
        }
        
        // æ—¥ä»˜ãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½
        function checkNewDay() {
            const today = new Date().toDateString();
            
            if (gameData.lastDate !== today) {
                // æ–°ã—ã„æ—¥ã«ãªã£ãŸå ´åˆã®å‡¦ç†
                if (gameData.lastDate) {
                    // å‰æ—¥ã®ãƒ‡ãƒ¼ã‚¿ã‚’å±¥æ­´ã«ä¿å­˜
                    if (gameData.todayData.swings > 0) {
                        gameData.history.push({
                            date: gameData.lastDate,
                            swings: gameData.todayData.swings,
                            steps: gameData.todayData.steps,
                            distance: gameData.todayData.distance
                        });
                        
                        // é€£ç¶šæ—¥æ•°ã®æ›´æ–°
                        const yesterday = new Date(Date.now() - 24 * 60 * 60 * 1000).toDateString();
                        if (gameData.lastDate === yesterday) {
                            gameData.consecutiveDays++;
                        } else {
                            gameData.consecutiveDays = 1;
                        }
                    } else {
                        // ç·´ç¿’ã—ãªã‹ã£ãŸå ´åˆã¯é€£ç¶šè¨˜éŒ²ãƒªã‚»ãƒƒãƒˆ
                        gameData.consecutiveDays = 0;
                    }
                } else {
                    // åˆå›èµ·å‹•ã®å ´åˆ
                    gameData.consecutiveDays = 0;
                }
                
                // ä»Šæ—¥ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ
                gameData.todayData = { swings: 0, steps: 0, distance: 0 };
                gameData.swingInputCount = 0;
                gameData.health = 3;
                gameData.hasBoost = false;
                gameData.lastDate = today;
                
                // ãƒœã‚¿ãƒ³ã¨ãƒ–ãƒ¼ã‚¹ãƒˆè¡¨ç¤ºã‚’ãƒªã‚»ãƒƒãƒˆ
                resetDailyUI();
            }
        }
        
        // æ—¥æ¬¡UIãƒªã‚»ãƒƒãƒˆ
        function resetDailyUI() {
            document.getElementById('boostDisplay').style.display = 'none';
            document.getElementById('dashBtn').disabled = false;
            document.getElementById('dashBtn').textContent = 'å®Ÿè¡Œ';
            document.getElementById('warningMessage').style.display = 'none';
        }
        
        // å…¨ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆ
        function resetAllData() {
            if (confirm('æœ¬å½“ã«å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚')) {
                gameData = {
                    totalSteps: 0,
                    totalSwings: 0,
                    health: 3,
                    hasBoost: false,
                    swingInputCount: 0,
                    lastDate: new Date().toDateString(),
                    consecutiveDays: 0,
                    todayData: { swings: 0, steps: 0, distance: 0 },
                    history: []
                };
                
                // å…¨ã¦ã®ä¿å­˜å ´æ‰€ã‚’ã‚¯ãƒªã‚¢
                document.cookie = 'koshienData=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
                const hiddenElement = document.getElementById('persistentGameData');
                if (hiddenElement) hiddenElement.textContent = '';
                
                // URLãƒãƒƒã‚·ãƒ¥ã‚‚ã‚¯ãƒªã‚¢
                if (window.history && window.history.replaceState) {
                    const currentUrl = window.location.href.split('#')[0];
                    window.history.replaceState(null, null, currentUrl);
                } else {
                    window.location.hash = '';
                }
                
                resetDailyUI();
                updateDisplay();
                updateMap();
                drawChart();
                saveGameData(); // ãƒªã‚»ãƒƒãƒˆå¾Œã«ã‚‚ä¿å­˜
                showAchievement('ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸï¼\næ–°ã—ã„æ—…ã‚’å§‹ã‚ã¾ã—ã‚‡ã†ï¼');
            }
        }
        
        // æ—¥ä»˜è¡¨ç¤º
        function updateDate() {
            const today = new Date();
            const options = { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                weekday: 'long'
            };
            document.getElementById('currentDate').textContent = today.toLocaleDateString('ja-JP', options);
        }
        
        // ç´ æŒ¯ã‚Šå®Ÿè¡Œ
        function addSwings() {
            const swingCount = parseInt(document.getElementById('swingCount').value) || 0;
            
            if (swingCount <= 0) {
                showAchievement("ç´ æŒ¯ã‚Šå›æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼");
                return;
            }
            
            if (gameData.swingInputCount >= 3) {
                showAchievement("ä»Šæ—¥ã®ç´ æŒ¯ã‚Šå…¥åŠ›ã¯3å›ã¾ã§ã™ï¼");
                return;
            }
            
            if (gameData.health <= 0) {
                document.getElementById('warningMessage').style.display = 'block';
                showAchievement("ä½“åŠ›ãŒä¸è¶³ã—ã¦ã„ã¾ã™ï¼\næŸ”è»Ÿä½“æ“ã§å›å¾©ã—ã¦ãã ã•ã„ã€‚");
                return;
            }
            
            // ä½“åŠ›æ¶ˆè²»
            gameData.health--;
            gameData.swingInputCount++;
            
            // æ­©æ•°è¨ˆç®—ï¼ˆãƒ–ãƒ¼ã‚¹ãƒˆåŠ¹æœé©ç”¨ï¼‰
            const stepsPerSwing = gameData.hasBoost ? 15 : 10;
            const stepsGained = swingCount * stepsPerSwing;
            
            // ãƒ‡ãƒ¼ã‚¿æ›´æ–°
            gameData.totalSteps += stepsGained;
            gameData.totalSwings += swingCount;
            gameData.todayData.swings += swingCount;
            gameData.todayData.steps += stepsGained;
            gameData.todayData.distance = gameData.todayData.steps * STEP_DISTANCE_M / 1000;
            
            // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('swingCount').value = 0;
            
            // ãƒ‡ãƒ¼ã‚¿ä¿å­˜
            saveGameData();
            
            // è¡¨ç¤ºæ›´æ–°
            updateDisplay();
            updateMap();
            
            // æˆæœè¡¨ç¤º
            showAchievement(`ç´ æŒ¯ã‚Š ${swingCount}å› å®Œäº†ï¼\n${stepsGained}æ­©å‰é€²ã—ã¾ã—ãŸï¼`);
            
            // ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³é”æˆãƒã‚§ãƒƒã‚¯
            checkMilestones();
        }
        
        // ãƒ€ãƒƒã‚·ãƒ¥å®Ÿè¡Œ
        function performDash() {
            if (gameData.hasBoost) {
                showAchievement("ä»Šæ—¥ã¯ã™ã§ã«ãƒ€ãƒƒã‚·ãƒ¥æ¸ˆã¿ã§ã™ï¼");
                return;
            }
            
            gameData.hasBoost = true;
            document.getElementById('boostDisplay').style.display = 'block';
            document.getElementById('dashBtn').disabled = true;
            document.getElementById('dashBtn').textContent = 'å®Œäº†';
            
            // ãƒ‡ãƒ¼ã‚¿ä¿å­˜
            saveGameData();
            
            showAchievement("ãƒ€ãƒƒã‚·ãƒ¥å®Œäº†ï¼\nç´ æŒ¯ã‚ŠåŠ¹æœãŒã‚¢ãƒƒãƒ—ã—ã¾ã—ãŸï¼\nï¼ˆ1å› = 15æ­©ï¼‰");
        }
        
        // æŸ”è»Ÿå®Ÿè¡Œ
        function performFlexibility() {
            if (gameData.health >= 3) {
                showAchievement("ä½“åŠ›ã¯æœ€å¤§ã§ã™ï¼");
                return;
            }
            
            gameData.health = Math.min(3, gameData.health + 1);
            document.getElementById('warningMessage').style.display = 'none';
            
            // ãƒ‡ãƒ¼ã‚¿ä¿å­˜
            saveGameData();
            
            updateDisplay();
            showAchievement("æŸ”è»Ÿä½“æ“å®Œäº†ï¼\nä½“åŠ›ãŒå›å¾©ã—ã¾ã—ãŸï¼");
        }
        
        // è¡¨ç¤ºæ›´æ–°
        function updateDisplay() {
            // åŸºæœ¬æƒ…å ±
            document.getElementById('totalSteps').textContent = gameData.totalSteps.toLocaleString();
            document.getElementById('distanceTraveled').textContent = (gameData.totalSteps * STEP_DISTANCE_M / 1000).toFixed(1);
            document.getElementById('stepsToGoal').textContent = Math.max(0, TOTAL_STEPS - gameData.totalSteps).toLocaleString();
            document.getElementById('swingInputCount').textContent = gameData.swingInputCount;
            
            // ä»Šæ—¥ã®è¨˜éŒ²
            document.getElementById('todaySwings').textContent = gameData.todayData.swings;
            document.getElementById('todaySteps').textContent = gameData.todayData.steps;
            document.getElementById('todayDistance').textContent = gameData.todayData.distance.toFixed(1);
            
            // ä½“åŠ›è¡¨ç¤º
            const hearts = document.querySelectorAll('.heart-icon');
            hearts.forEach((heart, index) => {
                if (index < gameData.health) {
                    heart.className = 'heart-icon heart-full';
                } else {
                    heart.className = 'heart-icon heart-empty';
                }
            });
            
            // æ¬¡ã®ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³
            updateNextMilestone();
            
            // ç´ æŒ¯ã‚Šãƒœã‚¿ãƒ³ã®çŠ¶æ…‹
            const swingBtn = document.getElementById('addSwingBtn');
            if (gameData.swingInputCount >= 3 || gameData.health <= 0) {
                swingBtn.disabled = true;
                if (gameData.swingInputCount >= 3) {
                    swingBtn.textContent = 'æœ¬æ—¥å®Œäº†';
                } else {
                    swingBtn.textContent = 'ä½“åŠ›ä¸è¶³';
                }
            } else {
                swingBtn.disabled = false;
                swingBtn.textContent = 'ç´ æŒ¯ã‚Šå®Ÿè¡Œ';
            }
        }
        
        // æ¬¡ã®ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³æ›´æ–°
        function updateNextMilestone() {
            const nextMilestone = milestones.find(m => m.steps > gameData.totalSteps);
            if (nextMilestone) {
                const stepsToNext = nextMilestone.steps - gameData.totalSteps;
                document.getElementById('nextMilestone').textContent = nextMilestone.name + 'ã¾ã§';
                document.getElementById('stepsToNext').textContent = stepsToNext.toLocaleString() + 'æ­©';
            } else {
                document.getElementById('nextMilestone').textContent = 'ç›®æ¨™é”æˆï¼';
                document.getElementById('stepsToNext').textContent = 'ğŸ‰';
            }
        }
        
        // åœ°å›³æ›´æ–°
        function updateMap() {
            const progress = Math.min(100, (gameData.totalSteps / TOTAL_STEPS) * 100);
            document.getElementById('currentPosition').style.left = progress + '%';
        }
        
        // ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³é”æˆãƒã‚§ãƒƒã‚¯
        function checkMilestones() {
            const justPassed = milestones.filter(m => 
                m.steps <= gameData.totalSteps && 
                m.steps > (gameData.totalSteps - gameData.todayData.steps)
            );
            
            justPassed.forEach(milestone => {
                setTimeout(() => {
                    showAchievement(`ğŸ¯ ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³é”æˆï¼\n${milestone.name}ã«åˆ°é”ã—ã¾ã—ãŸï¼`);
                }, 1000);
            });
        }
        
        // æˆæœè¡¨ç¤º
        function showAchievement(text) {
            const popup = document.getElementById('achievementPopup');
            document.getElementById('achievementText').textContent = text;
            popup.classList.add('show');
            
            setTimeout(() => {
                popup.classList.remove('show');
            }, 3000);
        }
        
        // ãƒãƒ£ãƒ¼ãƒˆæç”»ï¼ˆå®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ï¼‰
        function drawChart() {
            const canvas = document.getElementById('progressChart');
            const ctx = canvas.getContext('2d');
            
            // èƒŒæ™¯ã‚¯ãƒªã‚¢
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // è»¸ç·šæç”»
            ctx.strokeStyle = '#ddd';
            ctx.lineWidth = 1;
            
            // Yè»¸
            ctx.beginPath();
            ctx.moveTo(50, 20);
            ctx.lineTo(50, 240);
            ctx.stroke();
            
            // Xè»¸
            ctx.beginPath();
            ctx.moveTo(50, 240);
            ctx.lineTo(750, 240);
            ctx.stroke();
            
            // ãƒ©ãƒ™ãƒ«
            ctx.fillStyle = '#666';
            ctx.font = '12px Arial';
            ctx.fillText('æ—¥æ•°', 720, 255);
            ctx.save();
            ctx.translate(20, 130);
            ctx.rotate(-Math.PI/2);
            ctx.fillText('ç´¯è¨ˆæ­©æ•°', 0, 0);
            ctx.restore();
            
            // å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ã¾ãŸã¯ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
            let chartData = [];
            if (gameData.history.length > 0) {
                // å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨
                let cumulativeSteps = 0;
                chartData = gameData.history.map(day => {
                    cumulativeSteps += day.steps;
                    return cumulativeSteps;
                });
                // ä»Šæ—¥ã®ãƒ‡ãƒ¼ã‚¿ã‚‚è¿½åŠ 
                chartData.push(gameData.totalSteps);
            } else {
                // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿
                chartData = [0, gameData.totalSteps || 560, gameData.totalSteps + 560, gameData.totalSteps + 1120];
            }
            
            if (chartData.length > 1) {
                ctx.strokeStyle = '#1976D2';
                ctx.lineWidth = 3;
                ctx.beginPath();
                
                const maxSteps = Math.max(...chartData, 5000);
                chartData.forEach((steps, index) => {
                    const x = 50 + (index * (700 / Math.max(chartData.length - 1, 1)));
                    const y = 240 - (steps / maxSteps * 220);
                    if (index === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                    
                    // ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ãƒ³ãƒˆã‚’æç”»
                    ctx.fillStyle = '#1976D2';
                    ctx.beginPath();
                    ctx.arc(x, y, 4, 0, 2 * Math.PI);
                    ctx.fill();
                });
                ctx.stroke();
            }
        }
        
        // åˆæœŸåŒ–
        function init() {
            // è‡ªå‹•ä¿å­˜ã®è¨­å®š
            setupAutoSave();
            
            // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
            const dataLoaded = loadGameData();
            
            // æ–°ã—ã„æ—¥ã®ãƒã‚§ãƒƒã‚¯
            checkNewDay();
            
            updateDate();
            updateDisplay();
            updateMap();
            drawChart();
            
            // åˆå›èµ·å‹•ã®å ´åˆã¯æ—¥ä»˜ã‚’è¨­å®š
            if (!gameData.lastDate) {
                gameData.lastDate = new Date().toDateString();
                saveGameData();
            }
            
            // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿æˆåŠŸæ™‚ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            if (dataLoaded) {
                console.log('å‰å›ã®ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã—ãŸ');
            } else {
                console.log('æ–°ã—ã„ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ã—ã¾ã™');
            }
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«åˆæœŸåŒ–
        window.addEventListener('load', init);
    </script>
</body>
</html>