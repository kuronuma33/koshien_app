<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>甲子園への道のり</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
            min-height: 100vh;
            padding: 10px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #1976D2, #0D47A1);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2em;
            margin-bottom: 5px;
        }
        
        .map-section {
            padding: 20px;
            background: #f0f8ff;
        }
        
        .route-map {
            width: 100%;
            height: 200px;
            background: linear-gradient(90deg, #e3f2fd 0%, #bbdefb 50%, #90caf9 100%);
            border-radius: 15px;
            position: relative;
            border: 2px solid #1976D2;
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .route-line {
            position: absolute;
            top: 50%;
            left: 10px;
            right: 10px;
            height: 4px;
            background: #666;
            transform: translateY(-50%);
            border-radius: 2px;
        }
        
        .milestone {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            text-align: center;
            font-size: 12px;
            color: #333;
        }
        
        .milestone-marker {
            width: 12px;
            height: 12px;
            background: #666;
            border-radius: 50%;
            margin: 0 auto 5px;
        }
        
        .current-position {
            position: absolute;
            top: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            z-index: 10;
            transition: left 0.5s ease;
        }
        
        .progress-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .info-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        
        .info-number {
            font-size: 1.8em;
            font-weight: bold;
            color: #1976D2;
            margin-bottom: 5px;
        }
        
        .info-label {
            color: #666;
            font-size: 0.9em;
        }
        
        .stats-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            padding: 20px;
        }
        
        .training-panel, .health-panel {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
        }
        
        .panel-title {
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .health-display {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 20px 0;
        }
        
        .heart-icon {
            font-size: 2em;
            margin: 0 5px;
            transition: all 0.3s ease;
        }
        
        .heart-full {
            color: #e91e63;
        }
        
        .heart-empty {
            color: #ccc;
        }
        
        .boost-display {
            text-align: center;
            margin: 15px 0;
        }
        
        .boost-icon {
            font-size: 2em;
            color: #ff9800;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .input-section {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            border: 2px solid #e0e0e0;
        }
        
        .input-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 10px 0;
        }
        
        .input-label {
            font-weight: bold;
            color: #333;
        }
        
        .number-input {
            width: 80px;
            height: 40px;
            border: 2px solid #1976D2;
            border-radius: 8px;
            text-align: center;
            font-size: 1.1em;
            font-weight: bold;
        }
        
        .action-btn {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 12px 20px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
        }
        
        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76,175,80,0.3);
        }
        
        .action-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .dash-btn {
            background: linear-gradient(135deg, #FF5722, #D84315);
        }
        
        .dash-btn:hover {
            box-shadow: 0 5px 15px rgba(255,87,34,0.3);
        }
        
        .flexibility-btn {
            background: linear-gradient(135deg, #9C27B0, #7B1FA2);
        }
        
        .flexibility-btn:hover {
            box-shadow: 0 5px 15px rgba(156,39,176,0.3);
        }
        
        .chart-section {
            padding: 20px;
            background: #f5f5f5;
        }
        
        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            height: 300px;
            position: relative;
        }
        
        .achievement-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: linear-gradient(135deg, #FFD700, #FFA000);
            color: #333;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            text-align: center;
            z-index: 1000;
            transition: transform 0.3s ease;
        }
        
        .achievement-popup.show {
            transform: translate(-50%, -50%) scale(1);
        }
        
        .warning {
            background: #ffebee;
            color: #c62828;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
            font-weight: bold;
        }
        
        .reset-section {
            padding: 20px;
            background: #f5f5f5;
            border-top: 1px solid #ddd;
        }
        
        .reset-btn {
            background: linear-gradient(135deg, #f44336, #d32f2f);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 10px 20px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .reset-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(244,67,54,0.3);
        }
        
        .save-info {
            background: #e8f5e8;
            color: #2e7d2e;
            padding: 8px;
            border-radius: 6px;
            margin: 10px 0;
            text-align: center;
            font-size: 0.8em;
        }
        
        .save-info {
            background: #e8f5e8;
            color: #2e7d2e;
            padding: 8px;
            border-radius: 6px;
            margin: 10px 0;
            text-align: center;
            font-size: 0.8em;
        }
        
        .reset-section {
            padding: 20px;
            background: #f5f5f5;
            border-top: 1px solid #ddd;
        }
        
        .reset-btn {
            background: linear-gradient(135deg, #f44336, #d32f2f);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 10px 20px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .reset-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(244,67,54,0.3);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>⚾ 甲子園への道のり ⚾</h1>
            <p>葛飾区鎌倉 → 甲子園球場</p>
            <p id="currentDate"></p>
        </div>
        
        <div class="map-section">
            <div class="route-map">
                <div class="route-line"></div>
                
                <!-- 出発地点 -->
                <div class="milestone" style="left: 0%;">
                    <div class="milestone-marker"></div>
                    <div>葛飾区<br>鎌倉</div>
                </div>
                
                <!-- 中間地点 -->
                <div class="milestone" style="left: 12.5%;">
                    <div class="milestone-marker"></div>
                    <div>神奈川県</div>
                </div>
                
                <div class="milestone" style="left: 25%;">
                    <div class="milestone-marker"></div>
                    <div>静岡県</div>
                </div>
                
                <div class="milestone" style="left: 37.5%;">
                    <div class="milestone-marker"></div>
                    <div>愛知県</div>
                </div>
                
                <div class="milestone" style="left: 50%;">
                    <div class="milestone-marker"></div>
                    <div>岐阜県</div>
                </div>
                
                <div class="milestone" style="left: 62.5%;">
                    <div class="milestone-marker"></div>
                    <div>滋賀県</div>
                </div>
                
                <div class="milestone" style="left: 75%;">
                    <div class="milestone-marker"></div>
                    <div>京都府</div>
                </div>
                
                <div class="milestone" style="left: 87.5%;">
                    <div class="milestone-marker"></div>
                    <div>大阪府</div>
                </div>
                
                <!-- ゴール地点 -->
                <div class="milestone" style="left: 100%;">
                    <div class="milestone-marker" style="background: #4CAF50;"></div>
                    <div>甲子園<br>球場</div>
                </div>
                
                <!-- 現在位置 -->
                <div class="current-position" id="currentPosition" style="left: 0%;">🏃‍♂️</div>
            </div>
            
            <div class="progress-info">
                <div class="info-card">
                    <div class="info-number" id="totalSteps">0</div>
                    <div class="info-label">総歩数</div>
                </div>
                <div class="info-card">
                    <div class="info-number" id="distanceTraveled">0.0</div>
                    <div class="info-label">進んだ距離(km)</div>
                </div>
                <div class="info-card">
                    <div class="info-number" id="nextMilestone">神奈川県まで</div>
                    <div class="info-label" id="stepsToNext">120,000歩</div>
                </div>
                <div class="info-card">
                    <div class="info-number" id="stepsToGoal">1,000,000</div>
                    <div class="info-label">ゴールまで歩数</div>
                </div>
            </div>
        </div>
        
        <div class="stats-section">
            <div class="training-panel">
                <div class="panel-title">🏋️‍♂️ 今日のトレーニング</div>
                
                <div class="health-display">
                    <span>体力: </span>
                    <div id="healthHearts">
                        <span class="heart-icon heart-full">♥</span>
                        <span class="heart-icon heart-full">♥</span>
                        <span class="heart-icon heart-full">♥</span>
                    </div>
                </div>
                
                <div class="boost-display" id="boostDisplay" style="display: none;">
                    <div class="boost-icon">🚀</div>
                    <div>ブースト効果発動中！<br>素振り1回 = 15歩</div>
                </div>
                
                <div class="daily-limit">
                    素振り入力回数: <span id="swingInputCount">0</span>/3回
                </div>
                
                <div class="input-section">
                    <div class="input-row">
                        <span class="input-label">素振り回数:</span>
                        <input type="number" id="swingCount" class="number-input" min="0" value="0">
                    </div>
                    <button class="action-btn" id="addSwingBtn" onclick="addSwings()">素振り実行</button>
                </div>
                
                <div class="input-section">
                    <div class="input-row">
                        <span class="input-label">ダッシュ (10m×5本):</span>
                        <button class="action-btn dash-btn" id="dashBtn" onclick="performDash()">実行</button>
                    </div>
                </div>
                
                <div class="input-section">
                    <div class="input-row">
                        <span class="input-label">柔軟体操:</span>
                        <button class="action-btn flexibility-btn" id="flexibilityBtn" onclick="performFlexibility()">実行</button>
                    </div>
                </div>
                
                <div id="warningMessage" class="warning" style="display: none;">
                    体力が不足しています！柔軟体操で体力を回復してください。
                </div>
                
                <div class="save-info">
                    🔗 URLに自動保存中<br>
                    <small>ブックマーク推奨！</small>
                </div>
            </div>
            
            <div class="health-panel">
                <div class="panel-title">📊 今日の記録</div>
                <div class="info-card">
                    <div class="info-number" id="todaySwings">0</div>
                    <div class="info-label">今日の素振り回数</div>
                </div>
                <div class="info-card">
                    <div class="info-number" id="todaySteps">0</div>
                    <div class="info-label">今日の歩数</div>
                </div>
                <div class="info-card">
                    <div class="info-number" id="todayDistance">0.0</div>
                    <div class="info-label">今日の進距離(km)</div>
                </div>
                <div class="info-card">
                    <div class="info-number" id="consecutiveDays">0</div>
                    <div class="info-label">連続練習日数</div>
                </div>
            </div>
        </div>
        
        <div class="chart-section">
            <div class="panel-title">📈 過去の実績</div>
            <div class="chart-container">
                <canvas id="progressChart" width="800" height="260"></canvas>
            </div>
        </div>
        
        <div class="reset-section">
            <div class="panel-title">⚙️ 設定・データ管理</div>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-bottom: 15px;">
                <button class="action-btn" onclick="exportGameData()">📤 データ書き出し</button>
                <div>
                    <input type="file" id="importFile" accept=".json" onchange="importGameData(event)" style="display: none;">
                    <button class="action-btn" onclick="document.getElementById('importFile').click()">📥 データ読み込み</button>
                </div>
                <button class="reset-btn" onclick="resetAllData()">🗑️ 全データリセット</button>
            </div>
            
            <div class="save-info">
                🔗 データはURLに自動保存されます<br>
                <small>ブックマークすればデータ復元可能！</small>
            </div>
            
            <p style="margin-top: 10px; color: #666; font-size: 0.9em;">
                ※ローカルファイルでも確実にデータが保存されます<br>
                ※万一のために「データ書き出し」でバックアップをお勧めします
            </p>
        </div>
    </div>
    
    <div class="achievement-popup" id="achievementPopup">
        <h2>🎉 素晴らしい！ 🎉</h2>
        <p id="achievementText"></p>
    </div>
    
    <script>
        // ゲームデータ
        let gameData = {
            totalSteps: 0,
            totalSwings: 0,
            health: 3, // 最大3
            hasBoost: false,
            swingInputCount: 0, // 今日の素振り入力回数
            lastDate: null, // 最後にプレイした日
            consecutiveDays: 0,
            todayData: {
                swings: 0,
                steps: 0,
                distance: 0
            },
            history: []
        };
        
        // 目標設定
        const TOTAL_DISTANCE_KM = 500; // 葛飾区から甲子園までの概算距離
        const STEP_DISTANCE_M = 0.52; // 1歩の距離（メートル）
        const TOTAL_STEPS = Math.ceil(TOTAL_DISTANCE_KM * 1000 / STEP_DISTANCE_M); // 約96万歩
        
        // マイルストーン設定
        const milestones = [
            { name: "神奈川県", steps: Math.floor(TOTAL_STEPS * 0.125) },
            { name: "静岡県", steps: Math.floor(TOTAL_STEPS * 0.25) },
            { name: "愛知県", steps: Math.floor(TOTAL_STEPS * 0.375) },
            { name: "岐阜県", steps: Math.floor(TOTAL_STEPS * 0.5) },
            { name: "滋賀県", steps: Math.floor(TOTAL_STEPS * 0.625) },
            { name: "京都府", steps: Math.floor(TOTAL_STEPS * 0.75) },
            { name: "大阪府", steps: Math.floor(TOTAL_STEPS * 0.875) },
            { name: "甲子園球場", steps: TOTAL_STEPS }
        ];
        
        // データ保存・読み込み機能（ローカルファイル対応）
        function saveGameData() {
            try {
                const dataToSave = JSON.stringify(gameData);
                
                // 方法1: URLハッシュに保存（最も確実）
                if (window.history && window.history.replaceState) {
                    try {
                        const currentUrl = window.location.href.split('#')[0];
                        window.history.replaceState(null, null, currentUrl + '#gamedata=' + encodeURIComponent(dataToSave));
                    } catch (e) {
                        // history API が使えない場合は window.location.hash を使用
                        window.location.hash = 'gamedata=' + encodeURIComponent(dataToSave);
                    }
                }
                
                // 方法2: HTMLの隠し要素に保存
                let hiddenDataElement = document.getElementById('persistentGameData');
                if (!hiddenDataElement) {
                    hiddenDataElement = document.createElement('script');
                    hiddenDataElement.id = 'persistentGameData';
                    hiddenDataElement.type = 'application/json';
                    hiddenDataElement.style.display = 'none';
                    document.head.appendChild(hiddenDataElement);
                }
                hiddenDataElement.textContent = dataToSave;
                
                // 方法3: ページタイトルにバックアップデータを埋め込み
                const originalTitle = document.title.split(' | ')[0];
                document.title = originalTitle + ' | ' + btoa(dataToSave.substring(0, 100));
                
                // 方法4: Cookieも試行（HTTPSまたはローカルサーバーの場合）
                try {
                    document.cookie = `koshienData=${encodeURIComponent(dataToSave)}; expires=${new Date(Date.now() + 365*24*60*60*1000).toUTCString()}; path=/; SameSite=Lax`;
                } catch (cookieError) {
                    console.log('Cookie保存は利用できません（ローカルファイルの場合は正常）');
                }
                
                console.log('ゲームデータを保存しました（複数の方法で）');
                showSaveIndicator();
                
            } catch (error) {
                console.error('データ保存エラー:', error);
            }
        }
        
        function loadGameData() {
            try {
                let savedData = null;
                
                // 方法1: URLハッシュから読み込み（最優先）
                if (window.location.hash) {
                    const hash = window.location.hash.substring(1);
                    if (hash.startsWith('gamedata=')) {
                        try {
                            savedData = decodeURIComponent(hash.substring(9));
                        } catch (e) {
                            console.log('URLハッシュの解析に失敗');
                        }
                    }
                }
                
                // 方法2: HTMLの隠し要素から読み込み
                if (!savedData) {
                    const hiddenElement = document.getElementById('persistentGameData');
                    if (hiddenElement && hiddenElement.textContent) {
                        savedData = hiddenElement.textContent;
                    }
                }
                
                // 方法3: Cookieから読み込み
                if (!savedData) {
                    try {
                        const cookies = document.cookie.split(';');
                        for (let cookie of cookies) {
                            const [name, value] = cookie.trim().split('=');
                            if (name === 'koshienData') {
                                savedData = decodeURIComponent(value);
                                break;
                            }
                        }
                    } catch (cookieError) {
                        console.log('Cookie読み込みスキップ');
                    }
                }
                
                if (savedData) {
                    try {
                        const loadedData = JSON.parse(savedData);
                        if (loadedData && typeof loadedData === 'object') {
                            gameData = { ...gameData, ...loadedData };
                            console.log('ゲームデータを復元しました');
                            return true;
                        }
                    } catch (parseError) {
                        console.error('データの解析に失敗:', parseError);
                    }
                }
                
            } catch (error) {
                console.error('データ読み込みエラー:', error);
            }
            return false;
        }
        
        // 保存インジケーター表示
        function showSaveIndicator() {
            // 既存のインジケーターを削除
            const existing = document.querySelector('.save-indicator');
            if (existing) existing.remove();
            
            const indicator = document.createElement('div');
            indicator.className = 'save-indicator';
            indicator.innerHTML = '💾 保存完了';
            indicator.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #4CAF50;
                color: white;
                padding: 10px 15px;
                border-radius: 5px;
                font-size: 14px;
                z-index: 1000;
                animation: saveIndicatorAnim 2s ease-in-out;
            `;
            
            // アニメーション定義
            if (!document.querySelector('#saveIndicatorStyle')) {
                const style = document.createElement('style');
                style.id = 'saveIndicatorStyle';
                style.textContent = `
                    @keyframes saveIndicatorAnim {
                        0% { opacity: 0; transform: translateY(-10px) scale(0.8); }
                        20% { opacity: 1; transform: translateY(0) scale(1); }
                        80% { opacity: 1; transform: translateY(0) scale(1); }
                        100% { opacity: 0; transform: translateY(-10px) scale(0.8); }
                    }
                `;
                document.head.appendChild(style);
            }
            
            document.body.appendChild(indicator);
            
            // 2秒後に削除
            setTimeout(() => {
                if (indicator.parentNode) {
                    indicator.parentNode.removeChild(indicator);
                }
            }, 2000);
        }
        
        // データのバックアップとエクスポート機能
        function exportGameData() {
            const dataToExport = JSON.stringify(gameData, null, 2);
            const blob = new Blob([dataToExport], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'koshien-game-backup.json';
            a.click();
            URL.revokeObjectURL(url);
            showAchievement('データをエクスポートしました！\nファイルを保存してください。');
        }
        
        // データのインポート機能
        function importGameData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (importedData && typeof importedData === 'object') {
                        gameData = { ...gameData, ...importedData };
                        saveGameData();
                        updateDisplay();
                        updateMap();
                        drawChart();
                        showAchievement('データをインポートしました！');
                    }
                } catch (error) {
                    showAchievement('ファイルの読み込みに失敗しました。');
                }
            };
            reader.readAsText(file);
        }
        
        // 自動保存の設定
        function setupAutoSave() {
            // ページ離脱前にデータ保存
            window.addEventListener('beforeunload', function(e) {
                saveGameData();
            });
            
            // 定期的にデータ保存（30秒ごと）
            setInterval(function() {
                saveGameData();
            }, 30 * 1000);
            
            // フォーカス変更時にも保存
            window.addEventListener('blur', function() {
                saveGameData();
            });
            
            window.addEventListener('focus', function() {
                saveGameData();
            });
            
            // ページのvisibility変更時にも保存
            document.addEventListener('visibilitychange', function() {
                if (document.visibilityState === 'hidden') {
                    saveGameData();
                }
            });
        }
        
        // 日付チェック機能
        function checkNewDay() {
            const today = new Date().toDateString();
            
            if (gameData.lastDate !== today) {
                // 新しい日になった場合の処理
                if (gameData.lastDate) {
                    // 前日のデータを履歴に保存
                    if (gameData.todayData.swings > 0) {
                        gameData.history.push({
                            date: gameData.lastDate,
                            swings: gameData.todayData.swings,
                            steps: gameData.todayData.steps,
                            distance: gameData.todayData.distance
                        });
                        
                        // 連続日数の更新
                        const yesterday = new Date(Date.now() - 24 * 60 * 60 * 1000).toDateString();
                        if (gameData.lastDate === yesterday) {
                            gameData.consecutiveDays++;
                        } else {
                            gameData.consecutiveDays = 1;
                        }
                    } else {
                        // 練習しなかった場合は連続記録リセット
                        gameData.consecutiveDays = 0;
                    }
                } else {
                    // 初回起動の場合
                    gameData.consecutiveDays = 0;
                }
                
                // 今日のデータをリセット
                gameData.todayData = { swings: 0, steps: 0, distance: 0 };
                gameData.swingInputCount = 0;
                gameData.health = 3;
                gameData.hasBoost = false;
                gameData.lastDate = today;
                
                // ボタンとブースト表示をリセット
                resetDailyUI();
            }
        }
        
        // 日次UIリセット
        function resetDailyUI() {
            document.getElementById('boostDisplay').style.display = 'none';
            document.getElementById('dashBtn').disabled = false;
            document.getElementById('dashBtn').textContent = '実行';
            document.getElementById('warningMessage').style.display = 'none';
        }
        
        // 全データリセット
        function resetAllData() {
            if (confirm('本当に全てのデータをリセットしますか？\nこの操作は元に戻せません。')) {
                gameData = {
                    totalSteps: 0,
                    totalSwings: 0,
                    health: 3,
                    hasBoost: false,
                    swingInputCount: 0,
                    lastDate: new Date().toDateString(),
                    consecutiveDays: 0,
                    todayData: { swings: 0, steps: 0, distance: 0 },
                    history: []
                };
                
                // 全ての保存場所をクリア
                document.cookie = 'koshienData=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
                const hiddenElement = document.getElementById('persistentGameData');
                if (hiddenElement) hiddenElement.textContent = '';
                
                // URLハッシュもクリア
                if (window.history && window.history.replaceState) {
                    const currentUrl = window.location.href.split('#')[0];
                    window.history.replaceState(null, null, currentUrl);
                } else {
                    window.location.hash = '';
                }
                
                resetDailyUI();
                updateDisplay();
                updateMap();
                drawChart();
                saveGameData(); // リセット後にも保存
                showAchievement('データをリセットしました！\n新しい旅を始めましょう！');
            }
        }
        
        // 日付表示
        function updateDate() {
            const today = new Date();
            const options = { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                weekday: 'long'
            };
            document.getElementById('currentDate').textContent = today.toLocaleDateString('ja-JP', options);
        }
        
        // 素振り実行
        function addSwings() {
            const swingCount = parseInt(document.getElementById('swingCount').value) || 0;
            
            if (swingCount <= 0) {
                showAchievement("素振り回数を入力してください！");
                return;
            }
            
            if (gameData.swingInputCount >= 3) {
                showAchievement("今日の素振り入力は3回まです！");
                return;
            }
            
            if (gameData.health <= 0) {
                document.getElementById('warningMessage').style.display = 'block';
                showAchievement("体力が不足しています！\n柔軟体操で回復してください。");
                return;
            }
            
            // 体力消費
            gameData.health--;
            gameData.swingInputCount++;
            
            // 歩数計算（ブースト効果適用）
            const stepsPerSwing = gameData.hasBoost ? 15 : 10;
            const stepsGained = swingCount * stepsPerSwing;
            
            // データ更新
            gameData.totalSteps += stepsGained;
            gameData.totalSwings += swingCount;
            gameData.todayData.swings += swingCount;
            gameData.todayData.steps += stepsGained;
            gameData.todayData.distance = gameData.todayData.steps * STEP_DISTANCE_M / 1000;
            
            // 入力フィールドリセット
            document.getElementById('swingCount').value = 0;
            
            // データ保存
            saveGameData();
            
            // 表示更新
            updateDisplay();
            updateMap();
            
            // 成果表示
            showAchievement(`素振り ${swingCount}回 完了！\n${stepsGained}歩前進しました！`);
            
            // マイルストーン達成チェック
            checkMilestones();
        }
        
        // ダッシュ実行
        function performDash() {
            if (gameData.hasBoost) {
                showAchievement("今日はすでにダッシュ済みです！");
                return;
            }
            
            gameData.hasBoost = true;
            document.getElementById('boostDisplay').style.display = 'block';
            document.getElementById('dashBtn').disabled = true;
            document.getElementById('dashBtn').textContent = '完了';
            
            // データ保存
            saveGameData();
            
            showAchievement("ダッシュ完了！\n素振り効果がアップしました！\n（1回 = 15歩）");
        }
        
        // 柔軟実行
        function performFlexibility() {
            if (gameData.health >= 3) {
                showAchievement("体力は最大です！");
                return;
            }
            
            gameData.health = Math.min(3, gameData.health + 1);
            document.getElementById('warningMessage').style.display = 'none';
            
            // データ保存
            saveGameData();
            
            updateDisplay();
            showAchievement("柔軟体操完了！\n体力が回復しました！");
        }
        
        // 表示更新
        function updateDisplay() {
            // 基本情報
            document.getElementById('totalSteps').textContent = gameData.totalSteps.toLocaleString();
            document.getElementById('distanceTraveled').textContent = (gameData.totalSteps * STEP_DISTANCE_M / 1000).toFixed(1);
            document.getElementById('stepsToGoal').textContent = Math.max(0, TOTAL_STEPS - gameData.totalSteps).toLocaleString();
            document.getElementById('swingInputCount').textContent = gameData.swingInputCount;
            
            // 今日の記録
            document.getElementById('todaySwings').textContent = gameData.todayData.swings;
            document.getElementById('todaySteps').textContent = gameData.todayData.steps;
            document.getElementById('todayDistance').textContent = gameData.todayData.distance.toFixed(1);
            
            // 体力表示
            const hearts = document.querySelectorAll('.heart-icon');
            hearts.forEach((heart, index) => {
                if (index < gameData.health) {
                    heart.className = 'heart-icon heart-full';
                } else {
                    heart.className = 'heart-icon heart-empty';
                }
            });
            
            // 次のマイルストーン
            updateNextMilestone();
            
            // 素振りボタンの状態
            const swingBtn = document.getElementById('addSwingBtn');
            if (gameData.swingInputCount >= 3 || gameData.health <= 0) {
                swingBtn.disabled = true;
                if (gameData.swingInputCount >= 3) {
                    swingBtn.textContent = '本日完了';
                } else {
                    swingBtn.textContent = '体力不足';
                }
            } else {
                swingBtn.disabled = false;
                swingBtn.textContent = '素振り実行';
            }
        }
        
        // 次のマイルストーン更新
        function updateNextMilestone() {
            const nextMilestone = milestones.find(m => m.steps > gameData.totalSteps);
            if (nextMilestone) {
                const stepsToNext = nextMilestone.steps - gameData.totalSteps;
                document.getElementById('nextMilestone').textContent = nextMilestone.name + 'まで';
                document.getElementById('stepsToNext').textContent = stepsToNext.toLocaleString() + '歩';
            } else {
                document.getElementById('nextMilestone').textContent = '目標達成！';
                document.getElementById('stepsToNext').textContent = '🎉';
            }
        }
        
        // 地図更新
        function updateMap() {
            const progress = Math.min(100, (gameData.totalSteps / TOTAL_STEPS) * 100);
            document.getElementById('currentPosition').style.left = progress + '%';
        }
        
        // マイルストーン達成チェック
        function checkMilestones() {
            const justPassed = milestones.filter(m => 
                m.steps <= gameData.totalSteps && 
                m.steps > (gameData.totalSteps - gameData.todayData.steps)
            );
            
            justPassed.forEach(milestone => {
                setTimeout(() => {
                    showAchievement(`🎯 マイルストーン達成！\n${milestone.name}に到達しました！`);
                }, 1000);
            });
        }
        
        // 成果表示
        function showAchievement(text) {
            const popup = document.getElementById('achievementPopup');
            document.getElementById('achievementText').textContent = text;
            popup.classList.add('show');
            
            setTimeout(() => {
                popup.classList.remove('show');
            }, 3000);
        }
        
        // チャート描画（実際のデータを使用）
        function drawChart() {
            const canvas = document.getElementById('progressChart');
            const ctx = canvas.getContext('2d');
            
            // 背景クリア
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // 軸線描画
            ctx.strokeStyle = '#ddd';
            ctx.lineWidth = 1;
            
            // Y軸
            ctx.beginPath();
            ctx.moveTo(50, 20);
            ctx.lineTo(50, 240);
            ctx.stroke();
            
            // X軸
            ctx.beginPath();
            ctx.moveTo(50, 240);
            ctx.lineTo(750, 240);
            ctx.stroke();
            
            // ラベル
            ctx.fillStyle = '#666';
            ctx.font = '12px Arial';
            ctx.fillText('日数', 720, 255);
            ctx.save();
            ctx.translate(20, 130);
            ctx.rotate(-Math.PI/2);
            ctx.fillText('累計歩数', 0, 0);
            ctx.restore();
            
            // 実際のデータまたはサンプルデータを表示
            let chartData = [];
            if (gameData.history.length > 0) {
                // 実際のデータを使用
                let cumulativeSteps = 0;
                chartData = gameData.history.map(day => {
                    cumulativeSteps += day.steps;
                    return cumulativeSteps;
                });
                // 今日のデータも追加
                chartData.push(gameData.totalSteps);
            } else {
                // サンプルデータ
                chartData = [0, gameData.totalSteps || 560, gameData.totalSteps + 560, gameData.totalSteps + 1120];
            }
            
            if (chartData.length > 1) {
                ctx.strokeStyle = '#1976D2';
                ctx.lineWidth = 3;
                ctx.beginPath();
                
                const maxSteps = Math.max(...chartData, 5000);
                chartData.forEach((steps, index) => {
                    const x = 50 + (index * (700 / Math.max(chartData.length - 1, 1)));
                    const y = 240 - (steps / maxSteps * 220);
                    if (index === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                    
                    // データポイントを描画
                    ctx.fillStyle = '#1976D2';
                    ctx.beginPath();
                    ctx.arc(x, y, 4, 0, 2 * Math.PI);
                    ctx.fill();
                });
                ctx.stroke();
            }
        }
        
        // 初期化
        function init() {
            // 自動保存の設定
            setupAutoSave();
            
            // データ読み込み
            const dataLoaded = loadGameData();
            
            // 新しい日のチェック
            checkNewDay();
            
            updateDate();
            updateDisplay();
            updateMap();
            drawChart();
            
            // 初回起動の場合は日付を設定
            if (!gameData.lastDate) {
                gameData.lastDate = new Date().toDateString();
                saveGameData();
            }
            
            // データ読み込み成功時のメッセージ
            if (dataLoaded) {
                console.log('前回のデータを復元しました');
            } else {
                console.log('新しいゲームを開始します');
            }
        }
        
        // ページ読み込み時に初期化
        window.addEventListener('load', init);
    </script>
</body>
</html>